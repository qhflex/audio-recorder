# Basic Regression

## About This Document

基础回溯测试是一组简单的流程测试，属黑盒测试，不追求白盒流程覆盖、边界和压力测试。

基础回溯测试仅通过蓝牙接口行为和状态打印检查结果，以下两种数据正确性测试不包含在本回溯测试范围内，需通过其它方法检查：

1. 录音数据的正确性，即从麦克风i2s到存储在flash里adpcm数据；
2. 存储数据格式的正确性，包括flash的sector使用约定，发生rollover时的情况是否正确处理等；
3. 提取的adpcm数据格式的正确性，包括ble包复原的每包解码器state；

本测试也不包含完整的内部状态迁移测试。受内存限制项目无法使用细粒度的任务和分拆状态机，导致audio任务的内部状态机同时包含了多种逻辑，实际上项目未能详细和完备的定义状态机和迁移，仅凭程序员的直觉实现了大部分业务的状态迁移路径。因项目未有产品级质量需求，故在可接受的质量下，不做状态完备测试。

| 日期       | 作者                                 | 说明 |
| ---------- | ------------------------------------ | ---- |
| 2022-09-08 | 马天夫（matianfu@gingerologist.com） | 初稿 |



## 1 准备

### 1.1 工具

使用Code Composer Studio v10编译和debug代码。使用v10而不是v11是项目开始时选择的，因为图形化的编辑工具XGCONF在v11版本下未能很好工作。但项目定型不再调整`app_ble.cfg`配置文件后，理论上v11也可以使用；但开发者目前没有尝试过。

调试时触发命令使用nRF Connect工具。



### 1.2 代码配置

在构建配置文件（`ble5_simple_peripheral_cc2640r2lp_app_FlashROM_StackLibrary_RCOSC.opt`）中配置如下选择：

```
# -DLOG_ADPCM_DATA				禁止LOG ADPCM数据，这是调试录音数据完整性时的选项
# -DLOG_NVS_AFTER_AUTOSTOP		禁止在录音自动停止后打印NVS数据，这是调试flash存储数据正确性的选项

# -DDisplay_DISABLE_ALL         在生产版本上要打开该选项，禁止所有打印，在回溯测试时要禁止（注释掉）
# -DLOG_BADPCM_DATA	            禁止LOG BLE ADPCM数据包，这是调试读取时数据完整性的选项
```



### 1.3 硬件连接

根据客户需求，按键功能定义为处理器启动后检查启动原因，如果不是按键触发的启动，设备立刻深度休眠，仅按键可唤醒，其它所有片上外设和板载外设全部关闭电源。这个工作方式在TI的文档和例子程序里均称为`pinShutdown`，该方式是系统功耗最低的工作方式。



`pinShutdown`会断开debugger；而且在烧录程序后必须断开电源重新上电。

> 偶尔会遇到烧录不正确固件不完全工作的情况，因为`pinShutdown`导致UniFlash无法工作，找不到目标设备，需要多试几次断电上电，最终可以连接，并应该做一次完全擦除然后再烧录固件。



调试上的硬件连接有两种方式，如果需要烧录，需连接使用debugger；如果不需要烧录，也可以只连接电源，可选连接串口，但不需要连接debugger（红色的Launchpad板）。



#### 1.3.1 使用debugger的连接方式

参见debugging文档。



#### 1.3.2 不使用debugger的连接方式

如果目标板已经刷好所需固件，直接用电池供电，可以不使用Launchpad板，使用Pogopin夹子直接连USB串口调试器，所需信号参见debugging文档，Pogopin夹子上的TDO和GND接USB串口调试器的RX和GND即可，注意USB串口调试器上的电压跳线要跳到1.8V。



### 1.4 串口波特率

串口使用1500000波特率（1.5Mbps），需要在相应的串口工具里设置；其它设置为8N1，数据8bit，不使用流控，1bit stop。



## 2 测例列表

### 第一组，开关测试

测试项目：

1. 开机
2. 关机

| 编号    | 测试功能 | 前置     | 操作                                             | Pass条件                                            |
| ------- | -------- | -------- | ------------------------------------------------ | --------------------------------------------------- |
| a-01-01 | 开机     | 掉电状态 | 上电，hold住电源开关                             | 看到开关按下几秒钟后，串口有打印                    |
| a-01-02 | 开机     | 掉电状态 | 上电，hold住电源开关                             | 串口打印之后，用nRF Connect搜索目标设备，蓝牙可连接 |
| a-02-01 | 关机     | a-01-01  | 看到串口打印后松开电源开关，等几秒钟后再次hold住 | 看到串口停止打印                                    |
| a-02-02 | 关机     | a-01-02  | 看到串口打印后松开电源开关，等几秒钟后再次hold住 | 在nRF Connect里重新scan，应无法搜索到设备           |



### 第二组，功能和指令测试

测试项目：

1. 开机后自动开始录音
2. 发送`00`指令读取状态
3. 发送`01`指令停止录音
4. 发送`02`指令开始录音
5. 发送`03`指令停止读取
6. 发送`04`指令开始读取
7. 发送`04 xx xx xx xx`指令从某个sector开始读取（到最后）
8. 发送`04 xx xx xx xx xx xx xx xx`指令从某个sector开始读取到某个sector结束

| 测试编号 | 测试功能           | 前置      | 操作                                                         | Pass条件                                                     |
| -------- | ------------------ | --------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| b-01-01  | 开机后自动录音     | 同a-01-01 | 同a-01-01                                                    | 看到打印中有写入flash的输出，包括nvs erase，nvs write行      |
| b-02-01  | 读取status         | 同b-01-01 | 开机后nRFC连接，打开通知写入`00`                             | 看到status输出，recording为1，reading为0                     |
| b-03-01  | 停止自动录音       | 同b-01-01 | 开机后nRFC连接，打开通知写入`01`                             | nvs erase/nvs write输出停止，<br/>最后有status输出，且recording为0，reading为0 |
| b-03-02  | 停止手动开始的录音 | b-04-01   | 写入`01`                                                     | 同b-03-01                                                    |
| b-04-01  | 再次开始录音       | b-03-01   | 写入`02`                                                     | 命令写入后立刻有status输出，recording为1，reading为0<br/>开始nvs erase/nvs write输出，显示录音正在进行 |
| b-05-01  | 测试读取录音停止   | 录音停止  | 先写入`04`，等几秒钟后写入`03`                               | 同b-06-01，除了结束位置要求                                  |
| b-06-01  | 读取全部录音       | 录音停止  | 写入`04`                                                     | 保持手机和目标板近距离，可看到有较多数据传输后完成<br/>最后的read行和status显示确实读到了全部内容<br/>结束时recording为0，reading为0 |
| b-07-01  | 读取最后一条录音   | 录音停止  | 写入`00`找到recordings[20]<br/>拼出5字节格式的04命令写入     | 保持手机和目标板近距离，可看到有较多数据传输后完成<br/>最后的read行和status显示确实读到了全部内容<br/>结束时recording为0，reading为0 |
| b-08-01  | 读取最后一条录音   | 录音停止  | 写入00找到recordings[20]<br/>和recStart，拼出9字节格式<br/>的04命令写入 | 保持手机和目标板近距离，可看到有较多数据传输后完成<br/>最后的read行和status显示确实读到了全部内容<br/>结束时recording为0，reading为0 |

说明：

1. read行里的major是sector地址，在读取停止时最后一条的major应该是status里recStart - 1，且minor是24，则表明读到了最后的sector。
2. 5字节格式04命令，例如status里的recordings[20]是00000826，5字节格式的04命令就是`04 26 08 00 00`，即打印时uint32_t是big endian的，输入命令是little endian。
3. 9字节格式04命令，例如status里的recordings[20]是00000826，recStart是00000959，则9字节格式的命令是`04 26 08 00 00 59 09 00 00`，即`04`之后跟开始（包含）和结束（不包含）的sector地址，都是little endian的。



## 3 测试记录

| 日期       | 结果     | 说明       |
| ---------- | -------- | ---------- |
| 2022-09-09 | all pass | 最小测试集 |



## 4 补充说明

1. 受硬件条件所限，固件开发者没有进行功耗测试，硬件工程师可以使用开关测试所述的条件和操作进行测试；
2. 固件不禁止录音和读取录音同时进行，但App不该使用该方式；在粗略的测试中固件开发者观察到过两者同时工作的错误，但没有详细定义行为，也没有列出相应的测例，App开发者应避免这样使用；
3. 测例列表可补充其它必要的测例，尤其是App开发遇到的情况，但本文档不扩充压力测试、覆盖测试等其它类型的测试项目；如有需要另外增加相应文档。
